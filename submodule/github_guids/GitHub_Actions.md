## GitHub Actions

Общий принцип работы Github Actions такой: в нужном репозитории создается директория `.github/workflows`. 
Внутри нее размещаются файлы с описанием шагов, которые нужно выполнить на различные действия. 
В терминах Github Actions такое описание процесса называется `workflow`. В нем определяется на какие события 
реагировать и что конкретно делать.
GitHub Actions использует __синтаксис YAML__ для описания рабочего процесса. 
Каждый рабочий процесс хранится в виде отдельного файла YAML.

Ниже описание процесса "hello-world", который запускается на пуш в репозиторий:
```yml
# file: .github/workflows/hello-world.yml
name: hello-world

# on – определяет события, которые запускают воркфлоу
on: push

jobs:
  # build – произвольно выбранное имя задания
  # их может быть больше одного
  build:
    
    # операционная система для работы воркфлоу
    runs-on: ubuntu-latest
    
    # список шагов, которые надо выполнить
    steps: 
      
      # экшен, выполняет какую-то задачу
      # checkout – клонирует репозиторий
      - uses: actions/checkout@v2
      
      # run – произвольная bash-команда
      # ls -la выведет содержимое текущего репозитория
      - run: ls -la
```

Структура: 

__Воркфлоу / `Workflows`__
Каждый репозиторий на GitHub может содержать один или несколько воркфлоу. 
Каждый воркфлоу определяется в отдельном файле конфигурации в каталоге репозитория .github/workflows. 
Несколько воркфлоу могут выполняться параллельно.

__События / `Events`__
Воркфлоу может запускаться одним или несколькими событиями. Это могут быть внутренние события GitHub (например, пуш, релиз 
или пул-реквест), запланированные события (запускаются в определенное время — например, cron), 
или произвольные внешние события (запускаются вызовом Webhook API GitHub).

__Задания / `Jobs`__
Воркфлоу состоит из одного или нескольких заданий. Задание содержит набор команд, которые запускаются вместе с рабочим процессом. 
По умолчанию при запуске воркфлоу все его задания выполняются параллельно, однако между ними можно определить зависимость, 
чтобы они выполнялись последовательно.

__Раннеры / `Runners`__
Каждое задание выполняется на определенном раннере — временном сервере на GitHub с выбранной операционной системой (Linux, macOS или Windows). 
Также существуют автономные раннеры, которые позволяют создать свое окружение для выполнения экшена.

__Шаги / `Steps`__
Задания состоят из последовательности шагов. Шаг — это либо команда оболочки (shell command), либо экшен (action). 
Все шаги задания выполняются последовательно на раннере, связанном с заданием. По умолчанию в случае сбоя шага все следующие шаги задания пропускаются.

__Экшен / `Actions`__
Экшен — многократно используемый блок кода, который может служить шагом задания. Каждый экшен может принимать на вход параметры и создавать любые значения, 
которые затем можно использовать в других экшенах. Разработчики могут создавать собственные экшены или использовать опубликованные сообществом GitHub. 






-------------------------------------------------------------------------------------------------------------------------
### `Events`

`on` – определяет события, которые запускают воркфлоу.
Можно указать одно или несколько событий:
```yml
# Одно событие
on: push

# Несколько событий
on: [push, fork]
```
Если вы указываете несколько событий: достаточно чтобы произошло одно из них, 
чтобы запустить Workflow. Если одновременно происходит несколько инициирующих 
событий для вашего Workflow, будет произведено несколько запусков рабочего процесса.

Для некоторых событий можно использовать фильтры:
```yml
on:
  # событие - push
  push:
    # у push события есть branches фильтр
    # который запускает рабочий процесс только тогда, 
    # когда происходит отправка в указанную ветку
    branches:
      - main
      - 'releases/**'
```

Другие фильтры:
- `branches-ignore` - Workflow будет выполняться, если событие не нацелено на ветви, указанные с этим фильтром;
- `tags` - добавить теги
- `tags-ignore` - исключить теги
- `paths` - включить путь к файлу
- `paths-ignore` - исключить путь к файлу

Например, следующий рабочий процесс будет выполняться каждый раз, когда вы отправляете файл с++ ( .cpp )
```yml
on:
  push:
    paths:
      - '**.cpp'
```

Нельзя использовать `branches /tags /paths` и `branches /tags /paths-ignore` для одного и того же события в рабочем процессе.
Если в одном собтии нужно и включить и исключить, например ветки, используйте фильтр вместе с __`!`__, чтобы указать, что следует исключить:
```yml
on:
  push:
    branches:
      - main
      - !dev
```

Для некоторых событий можно использовать дополнительные действия, такие как: `created`, `deleted`, `completed` и др.
Следующий рабочий процесс запускается, когда кто-то открывает issues:
```yml
on:
  issues:
    types:
      - opened
```

Рассмотрим некоторые события и их дополнительные действия: 

###### `create`
Запускает Workflow, когда кто-то что-то создает в репозитории рабочего процесса (напр.ветвь или тег Git).
```yml
on:
  create 
```



###### `delete`
Запускает Workflow, когда кто-то что-то удаляет в репозитории рабочего процесса (напр.ветвь или тег Git).
```yml
on:
  delete
```

###### `schedule`
Позволяет запустить Workflow в запланированное время.
Один Workflow может быть запущен несколькими `schedule` событиями. 
Можно получить доступ к запланированному событию, которое инициировало Workflow, через `github.event.schedule` контекст. 
В следующем примере рабочий процесс запускается в 5:30 UTC каждый понедельник-четверг, 
но пропускает `Not on Monday or Wednesday` шаг в понедельник и среду.

```yml
on:
  schedule:
    - cron: '30 5 * * 1,3'
    - cron: '30 5 * * 2,4'

jobs:
  test_schedule:
    runs-on: ubuntu-latest
    steps:
      - name: Not on Monday or Wednesday
        if: github.event.schedule != '30 5 * * 1,3'
        run: echo "This step will be skipped on Monday and Wednesday"
      - name: Every time
        run: echo "This step will always run"
```

###### `workflow_dispatch`
Используется, чтобы вручную запустить Workflow. Это можно сделать с помощью GitHub API, GitHub CLI или интерфейса браузера GitHub.


Все __ДОПОЛНИТЬ И ДОБАВИТЬ ССЫЛКУ НА ОСТАЛЬНЫЕ ТРИГЕРЫ__










-----------------------------------------------------------------------------------------------------------------------------
### `Jobs`

Задания в воркфлоу обозначают какую-то часть процесса интеграции — например, сборку, тестирование, деплой и тому подобное. 
Каждое задание выполняется в среде исполнителя, указанной параметром `runs-on`.

Если необходимо, чтобы задания выполнялись по очереди, а не параллельно, используется `jobs.<job_id>.needs`:
```yml
jobs:
  job1:
  job2:
    needs: job1
  job3:
    needs: [job1, job2]
```
В примере выше `job1` должен выполниться корректно без ошибок, чтобы начался `job2`, а `job3` ожидает корректного завершения обоих `job1` и `job2`.

Если же нужно, чтобы задание выполнялось последовательно, независимо от успешности выполнения предыдущего задания:
```yml
jobs:
  job1:
  job2:
    needs: job1
  job3:
    if: ${{ always() }}
    needs: [job1, job2]
```
В этом примере `job3` использует условное выражение `always()`, чтобы оно всегда выполнялось после завершения `job1` и `job2`, независимо от того, были ли они выполнены корректно.


__Переменные окружения__
С помощью ключа `env` можно добавить переменные окружения, доступные для всех шагов текущего задания:
```yml
jobs:
  run:
    env:
      RAILS_ENV: staging
      DEBUG: 1
```

Вот как их можно использовать прямо в шагах:
```yml
steps:
  - run: echo "Workflow name: $GITHUB_WORKFLOW"
```

Полный список [переменных окружения](https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables)









-----------------------------------------------------------------------------------------------------------------------------
### `Actions`

С помощью экшенов значительно сокращается количество кода в воркфлоу, а стандартный цикл сборки 
и тестирования проходит буквально за минуты на любом стеке.
Чаще всего в сборках используется экшен checkout, который клонирует репозиторий в рабочую директорию:
```yml
steps:
  - uses: actions/checkout@v2
```
Экшен работает как один из шагов задания. Для этого вместо ключа `run` используется ключ `uses`, за которым идет имя экшена. 
имя экшена берем из [каталога экшенов](https://github.com/marketplace?type=actions)

Понять, что и откуда можно по имени экшена, оно соответствует структуре ссылок самого Github: 
_имя пользователя или команды/название репозитория_. Встроенные экшены находятся в команде _actions+_.

Кроме имени экшена Github требует указания его версии. Это сделано в целях надежности, 
чтобы обновления экшена не могли привести к случайной поломке всех репозиториев, которые его используют. 
Следить за версиями придется самостоятельно, поглядывая в README конкретного репозитория с экшеном.

У экшена могут быть параметры. Они задаются через ключ `with`.
Вот пример [стороннего экшена](https://github.com/marketplace/actions/build-c-project), который создает проекты cmake:
```yml
name: C/C++ CI

on: [push]

jobs:
  ubuntu-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2.0.0
    - name: Build project
      uses: nicledomaS/cmake_build_action@v1.4
      with:
        submodule_update: ON
        run_tests: ON
        unit_test_build: -Dtest=ON
```







Чтобы написать воркфлоу, нужно ответить на вопросы: 

- когда? - событие

- что? - задание

- как? - шаги

```yaml
# Имя рабочего процесса, которое будет отображаться на вкладке «Actions» репозитория GitHub.
name: 'project_tests'

# Ключевое слово `on` позволяет определить события, которые инициируют запуск рабочего процесса
on: 
  
  # возможность запускать рабочий процесс вручную из пользовательского интерфейса
  workflow_dispatch:
  # запуск рабочего процесса при пуше в дефолтную ветку
  push:
    branches: [ $default-branch ]

# обозначим задачу
jobs:
  # id нашей задачи
  test_jobs:
    # выберим Runner
    runs-on: ubuntu-latest;
    
    # Обозначим шаги, которые буду выполняться для test_jobs задания
    steps:
      - name: checkout
        # с помощью ключа uses мы может подключить уже готовые actions 
        uses: actions/checkout@v3 

```









